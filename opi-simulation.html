<!DOCTYPE html>
<html lang="ko" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‚¼ì„±ì „ì OPI ì£¼ì‹ë³´ìƒ ì‹œë®¬ë ˆì´í„°</title>
    <meta name="description" content="ì‚¼ì„±ì „ì OPI ì„±ê³¼ê¸‰ ì£¼ì‹ë³´ìƒ ë¹„ìœ¨ ìµœì í™” ì‹œë®¬ë ˆì´í„°">

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        samsung: {
                            blue: '#1428a0',
                            light: '#4a5fc1',
                            dark: '#0d1a6b'
                        }
                    }
                }
            }
        }
    </script>

    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Pretendard Font -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css">

    <style>
        body { font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, sans-serif; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        input[type="range"] { -webkit-appearance: none; height: 8px; border-radius: 4px; background: #e2e8f0; }
        .dark input[type="range"] { background: #374151; }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; width: 24px; height: 24px; border-radius: 50%;
            background: linear-gradient(135deg, #1428a0, #4a5fc1); cursor: pointer;
            box-shadow: 0 2px 6px rgba(20, 40, 160, 0.3);
        }
        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #1428a0; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen">
    <!-- Loading Overlay -->
    <div id="loading" class="hidden fixed inset-0 bg-white/80 dark:bg-gray-900/80 z-50 flex items-center justify-center">
        <div class="text-center">
            <div class="spinner mx-auto mb-4"></div>
            <p class="text-gray-600 dark:text-gray-400">ê³„ì‚° ì¤‘...</p>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Header -->
        <header class="text-center mb-10">
            <div class="flex justify-end mb-4">
                <button id="dark-mode-toggle" class="p-2 rounded-lg bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
                    <svg class="w-6 h-6 hidden dark:block" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
                    </svg>
                    <svg class="w-6 h-6 block dark:hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
                    </svg>
                </button>
            </div>
            <h1 class="text-3xl sm:text-4xl font-bold bg-gradient-to-r from-samsung-blue to-samsung-light bg-clip-text text-transparent mb-3">
                ì‚¼ì„±ì „ì OPI ì£¼ì‹ë³´ìƒ ì‹œë®¬ë ˆì´í„°
            </h1>
            <p class="text-gray-600 dark:text-gray-400 max-w-2xl mx-auto">
                OPI ì„±ê³¼ê¸‰ì˜ ì£¼ì‹ë³´ìƒ ë¹„ìœ¨ì— ë”°ë¥¸ ì˜ˆìƒ ìˆ˜ë ¹ì•¡ì„ ë¹„êµí•˜ê³ , ìµœì ì˜ ë¹„ìœ¨ì„ ì°¾ì•„ë³´ì„¸ìš”.
            </p>
        </header>

        <!-- Input Section -->
        <section class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6 sm:p-8 mb-8">
            <h2 class="text-xl font-bold mb-6 flex items-center gap-2">
                <span class="w-8 h-8 bg-samsung-blue/10 dark:bg-samsung-light/20 rounded-lg flex items-center justify-center text-samsung-blue dark:text-samsung-light">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                    </svg>
                </span>
                ê¸°ë³¸ ì •ë³´ ì…ë ¥
            </h2>

            <form id="simulator-form" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="annual-salary" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">ê³„ì•½ì—°ë´‰ (ì›)</label>
                        <input type="text" id="annual-salary" inputmode="numeric"
                               class="w-full px-4 py-3 border border-gray-200 dark:border-gray-700 rounded-xl bg-gray-50 dark:bg-gray-900 focus:ring-2 focus:ring-samsung-blue focus:border-transparent outline-none"
                               placeholder="ì˜ˆ: 150,000,000" required>
                        <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">ì„¸ì „ ì—°ë´‰ ì „ì²´ ê¸ˆì•¡</p>
                    </div>

                    <div>
                        <label for="opi-rate" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">ì˜ˆìƒ OPI ë¹„ìœ¨</label>
                        <div class="flex items-center gap-4">
                            <input type="range" id="opi-rate" min="0" max="50" value="25" step="5" class="flex-1 h-2 cursor-pointer">
                            <output id="opi-rate-value" class="w-16 text-center text-lg font-bold text-samsung-blue dark:text-samsung-light">25%</output>
                        </div>
                        <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">0% ~ 50% (íšŒì‚¬ ì„±ê³¼ì— ë”°ë¼)</p>
                    </div>

                    <div>
                        <label for="base-price" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">ê¸°ì¤€ì£¼ê°€ (ì›)</label>
                        <input type="text" id="base-price" inputmode="numeric"
                               class="w-full px-4 py-3 border border-gray-200 dark:border-gray-700 rounded-xl bg-gray-50 dark:bg-gray-900 focus:ring-2 focus:ring-samsung-blue focus:border-transparent outline-none"
                               placeholder="ì˜ˆ: 55,000" required>
                        <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">OPI ì§€ê¸‰ ì‹œì ì˜ ê¸°ì¤€ ì£¼ê°€</p>
                    </div>

                    <div>
                        <label for="future-price" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">ë¯¸ë˜ ì˜ˆìƒ ì£¼ê°€ (ì›)</label>
                        <input type="text" id="future-price" inputmode="numeric"
                               class="w-full px-4 py-3 border border-gray-200 dark:border-gray-700 rounded-xl bg-gray-50 dark:bg-gray-900 focus:ring-2 focus:ring-samsung-blue focus:border-transparent outline-none"
                               placeholder="ì˜ˆ: 70,000" required>
                        <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">1ë…„ í›„ ì˜ˆìƒ ì£¼ê°€ (ë³´ìœ  ì¢…ë£Œ ì‹œì )</p>
                    </div>
                </div>

                <button type="submit" class="w-full bg-gradient-to-r from-samsung-blue to-samsung-light text-white font-semibold py-4 px-6 rounded-xl hover:opacity-90 active:scale-[0.98] transition-all shadow-lg shadow-samsung-blue/25">
                    ì‹œë®¬ë ˆì´ì…˜ ì‹¤í–‰
                </button>
            </form>
        </section>

        <!-- Results Section -->
        <section id="results" class="hidden space-y-8">
            <!-- Summary Cards -->
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 sm:gap-6">
                <div class="bg-gradient-to-br from-samsung-blue to-samsung-light text-white rounded-2xl p-6 shadow-lg">
                    <h3 class="text-sm font-medium opacity-80 mb-1">ìµœì  ì¶”ì²œ ë¹„ìœ¨</h3>
                    <div id="optimal-ratio" class="text-4xl font-bold">-</div>
                    <p class="text-xs opacity-70 mt-2">ì´ ìˆ˜ë ¹ì•¡ ê¸°ì¤€</p>
                </div>
                <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-lg border border-gray-100 dark:border-gray-700">
                    <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">OPI ì§€ê¸‰ì•¡ (ì„¸ì „)</h3>
                    <div id="opi-amount" class="text-3xl font-bold text-gray-900 dark:text-white">-</div>
                </div>
                <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-lg border border-gray-100 dark:border-gray-700">
                    <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">ìµœëŒ€ ìˆ˜ë ¹ì•¡ (1ë…„ í›„)</h3>
                    <div id="max-total" class="text-3xl font-bold text-green-600 dark:text-green-400">-</div>
                </div>
            </div>

            <!-- ë¹„ìœ¨ë³„ ë¹„êµ í…Œì´ë¸” -->
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6 sm:p-8">
                <h2 class="text-xl font-bold mb-6">ì£¼ì‹ë³´ìƒ ë¹„ìœ¨ë³„ ë¹„êµ</h2>
                <div class="overflow-x-auto">
                    <table id="comparison-table" class="w-full text-sm">
                        <thead>
                            <tr class="text-xs uppercase text-gray-500 dark:text-gray-400 bg-gray-50 dark:bg-gray-700/50">
                                <th class="px-4 py-3 text-left font-semibold">ë¹„ìœ¨</th>
                                <th class="px-4 py-3 text-right font-semibold">ì£¼ì‹ìˆ˜</th>
                                <th class="px-4 py-3 text-right font-semibold">ì¶”ê°€í˜œíƒ(15%)</th>
                                <th class="px-4 py-3 text-right font-semibold">ì£¼ì‹ê°€ì¹˜(1ë…„í›„)</th>
                                <th class="px-4 py-3 text-right font-semibold">ê³¼ì„¸ì†Œë“</th>
                                <th class="px-4 py-3 text-right font-semibold">ì„¸ê¸ˆ</th>
                                <th class="px-4 py-3 text-right font-semibold">ì„¸í›„ ì‹¤ìˆ˜ë ¹</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200 dark:divide-gray-700"></tbody>
                    </table>
                </div>
            </div>

            <!-- Charts -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">
                    <h3 class="text-lg font-bold mb-4">ë¹„ìœ¨ë³„ ì´ ìˆ˜ë ¹ì•¡ ë¹„êµ</h3>
                    <div class="h-80"><canvas id="ratio-chart"></canvas></div>
                </div>
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">
                    <h3 class="text-lg font-bold mb-4">ì£¼ê°€ ì‹œë‚˜ë¦¬ì˜¤ë³„ ìˆ˜ìµ ë¶„ì„</h3>
                    <div class="h-80"><canvas id="price-scenario-chart"></canvas></div>
                </div>
            </div>

            <!-- ì£¼ê°€ ì‹œë‚˜ë¦¬ì˜¤ í…Œì´ë¸” -->
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6 sm:p-8">
                <h2 class="text-xl font-bold mb-2">ì£¼ê°€ ë³€ë™ ì‹œë‚˜ë¦¬ì˜¤ ë¶„ì„</h2>
                <p class="text-sm text-gray-500 dark:text-gray-400 mb-6">ì£¼ê°€ ë³€ë™ì— ë”°ë¥¸ ìµœì  ë¹„ìœ¨ ë³€í™”</p>
                <div class="overflow-x-auto">
                    <table id="price-scenario-table" class="w-full text-sm">
                        <thead>
                            <tr class="text-xs uppercase text-gray-500 dark:text-gray-400 bg-gray-50 dark:bg-gray-700/50">
                                <th class="px-3 py-2 text-left font-semibold">ë³€ë™</th>
                                <th class="px-3 py-2 text-right font-semibold">ì£¼ê°€</th>
                                <th class="px-3 py-2 text-right font-semibold">0%</th>
                                <th class="px-3 py-2 text-right font-semibold">10%</th>
                                <th class="px-3 py-2 text-right font-semibold">20%</th>
                                <th class="px-3 py-2 text-right font-semibold">30%</th>
                                <th class="px-3 py-2 text-right font-semibold">40%</th>
                                <th class="px-3 py-2 text-right font-semibold">50%</th>
                                <th class="px-3 py-2 text-right font-semibold">ìµœì </th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200 dark:divide-gray-700"></tbody>
                    </table>
                </div>
            </div>

            <!-- ì„¸ê¸ˆ ë¹„êµ -->
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6 sm:p-8">
                <h2 class="text-xl font-bold mb-6">ì„¸ê¸ˆ ì˜í–¥ ë¶„ì„</h2>
                <div id="tax-comparison"></div>
            </div>

            <!-- ì†ìµë¶„ê¸°ì  -->
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6 sm:p-8 border-l-4 border-indigo-500">
                <h2 class="text-xl font-bold mb-6">ì†ìµë¶„ê¸°ì  ë¶„ì„</h2>
                <div id="breakeven-analysis"></div>
            </div>
        </section>

        <!-- Footer -->
        <footer class="mt-12 text-center text-sm text-gray-500 dark:text-gray-400 space-y-1">
            <p>* ë³¸ ì‹œë®¬ë ˆì´í„°ëŠ” ì°¸ê³ ìš©ì´ë©°, ì‹¤ì œ ê²°ê³¼ì™€ ë‹¤ë¥¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            <p>* ì„¸ê¸ˆ ê³„ì‚°ì€ 2025ë…„ ê¸°ì¤€ 4ëŒ€ë³´í—˜ ë° ì†Œë“ì„¸ ëˆ„ì§„ì„¸ìœ¨ì„ ì ìš©í•©ë‹ˆë‹¤.</p>
            <p class="pt-4 text-gray-400 dark:text-gray-600">Made for Samsung Employees | 2025</p>
        </footer>
    </div>

    <script>
    // ==================== Calculator ====================
    const CONFIG = {
        STOCK_RATIO_OPTIONS: [0, 10, 20, 30, 40, 50],
        ADDITIONAL_BENEFIT_RATE: 0.15,
        NATIONAL_PENSION_RATE: 0.045,
        NATIONAL_PENSION_CAP: 3258000,
        HEALTH_INSURANCE_RATE: 0.03545,
        LONG_TERM_CARE_RATE: 0.1295,
        EMPLOYMENT_INSURANCE_RATE: 0.009,
        TAX_BRACKETS: [
            { limit: 14000000, rate: 0.06, deduction: 0 },
            { limit: 50000000, rate: 0.15, deduction: 1260000 },
            { limit: 88000000, rate: 0.24, deduction: 5760000 },
            { limit: 150000000, rate: 0.35, deduction: 15440000 },
            { limit: 300000000, rate: 0.38, deduction: 19940000 },
            { limit: 500000000, rate: 0.40, deduction: 25940000 },
            { limit: 1000000000, rate: 0.42, deduction: 35940000 },
            { limit: Infinity, rate: 0.45, deduction: 65940000 }
        ],
        LOCAL_TAX_RATE: 0.10,
        PRICE_CHANGE_SCENARIOS: [-30, -20, -10, 0, 10, 20, 30]
    };

    function calculateSocialInsurance(grossPay) {
        const nationalPension = Math.min(grossPay * CONFIG.NATIONAL_PENSION_RATE, CONFIG.NATIONAL_PENSION_CAP);
        const healthInsurance = grossPay * CONFIG.HEALTH_INSURANCE_RATE;
        const longTermCare = healthInsurance * CONFIG.LONG_TERM_CARE_RATE;
        const employmentInsurance = grossPay * CONFIG.EMPLOYMENT_INSURANCE_RATE;
        return { nationalPension, healthInsurance, longTermCare, employmentInsurance, total: nationalPension + healthInsurance + longTermCare + employmentInsurance };
    }

    function calculateIncomeTax(taxableIncome) {
        if (taxableIncome <= 0) return { incomeTax: 0, localTax: 0, total: 0 };
        for (const bracket of CONFIG.TAX_BRACKETS) {
            if (taxableIncome <= bracket.limit) {
                const incomeTax = Math.max(0, taxableIncome * bracket.rate - bracket.deduction);
                const localTax = incomeTax * CONFIG.LOCAL_TAX_RATE;
                return { incomeTax, localTax, total: incomeTax + localTax };
            }
        }
    }

    function calculateNetPay(grossPay) {
        const insurance = calculateSocialInsurance(grossPay);
        const taxableIncome = grossPay - insurance.total;
        const tax = calculateIncomeTax(taxableIncome);
        return { grossPay, insurance, tax, totalDeductions: insurance.total + tax.total, netPay: grossPay - insurance.total - tax.total };
    }

    function calculateOPIReward(params) {
        const { annualSalary, opiRate, baseStockPrice, futureStockPrice, stockRatio } = params;
        const opiAmount = annualSalary * (opiRate / 100);
        const stockRewardAmount = opiAmount * (stockRatio / 100);
        const cashAmountGross = opiAmount - stockRewardAmount;
        const additionalBenefit = stockRewardAmount * CONFIG.ADDITIONAL_BENEFIT_RATE;
        const totalStockReward = stockRewardAmount + additionalBenefit;
        const stockCount = Math.floor(totalStockReward / baseStockPrice);
        const remainder = totalStockReward - (stockCount * baseStockPrice);
        const futureStockValue = stockCount * futureStockPrice;
        // ì„¸ê¸ˆ ê³„ì‚° (ì—°ë´‰ + OPI + ì¶”ê°€í˜œíƒ í•©ì‚°, í‰ê°€ì°¨ì•¡ì€ ê³¼ì„¸ ëŒ€ìƒ ì•„ë‹˜)
        const salaryOnlyTax = calculateNetPay(annualSalary);
        const opiTaxableIncome = opiAmount + additionalBenefit;
        const totalIncome = annualSalary + opiTaxableIncome;
        const totalTax = calculateNetPay(totalIncome);
        const opiTaxAmount = totalTax.totalDeductions - salaryOnlyTax.totalDeductions;
        // ì‹¤ìˆ˜ë ¹ì•¡ = ì´ìˆ˜ë ¹(ì„¸ì „) - ì„¸ê¸ˆ
        const grossTotal = cashAmountGross + futureStockValue + remainder;
        const totalReceived = grossTotal - opiTaxAmount;
        // 100% í˜„ê¸ˆ ìˆ˜ë ¹ ëŒ€ë¹„
        const allCashTotalTax = calculateNetPay(annualSalary + opiAmount);
        const allCashOpiTax = allCashTotalTax.totalDeductions - salaryOnlyTax.totalDeductions;
        const allCashNet = opiAmount - allCashOpiTax;
        const vsAllCash = totalReceived - allCashNet;
        return { stockRatio, opiAmount, stockRewardAmount, additionalBenefit, totalStockReward, stockCount, remainder, futureStockValue, cashAmountGross, opiTaxableIncome, opiTaxAmount, grossTotal, totalReceived, allCashNet, vsAllCash };
    }

    function calculateAllScenarios(baseParams) {
        const scenarios = CONFIG.STOCK_RATIO_OPTIONS.map(ratio => calculateOPIReward({ ...baseParams, stockRatio: ratio }));
        const optimalScenario = scenarios.reduce((best, current) => current.totalReceived > best.totalReceived ? current : best);
        return { scenarios, optimalRatio: optimalScenario.stockRatio, optimalScenario };
    }

    function analyzePriceScenarios(baseParams) {
        return CONFIG.PRICE_CHANGE_SCENARIOS.map(change => {
            const futurePrice = baseParams.baseStockPrice * (1 + change / 100);
            const scenarios = calculateAllScenarios({ ...baseParams, futureStockPrice: futurePrice });
            return { priceChange: change, futurePrice, ...scenarios };
        });
    }

    function compareTaxImpact(params) {
        const { annualSalary, opiRate, baseStockPrice, futureStockPrice, stockRatio } = params;
        const opiAmount = annualSalary * (opiRate / 100);
        // 100% í˜„ê¸ˆ ìˆ˜ë ¹ (ì—°ë´‰ í•©ì‚° ê¸°ì¤€ í•œê³„ì„¸ìœ¨ ì ìš©)
        const salaryOnlyTax = calculateNetPay(annualSalary);
        const salaryPlusOpiTax = calculateNetPay(annualSalary + opiAmount);
        const opiMarginalTax = salaryPlusOpiTax.totalDeductions - salaryOnlyTax.totalDeductions;
        const allCashNetAmount = opiAmount - opiMarginalTax;
        const allCash = { grossAmount: opiAmount, taxableIncome: opiAmount, tax: opiMarginalTax, netAmount: allCashNetAmount, futureValue: allCashNetAmount };
        const stockResult = calculateOPIReward(params);
        const withStock = { grossAmount: opiAmount, additionalBenefit: stockResult.additionalBenefit, taxableIncome: stockResult.opiTaxableIncome, tax: stockResult.opiTaxAmount, stockCount: stockResult.stockCount, futureStockValue: stockResult.futureStockValue, totalFutureValue: stockResult.totalReceived };
        const breakEvenPrice = baseStockPrice * (1 - CONFIG.ADDITIONAL_BENEFIT_RATE / (1 + CONFIG.ADDITIONAL_BENEFIT_RATE));
        const breakEvenChange = ((breakEvenPrice / baseStockPrice) - 1) * 100;
        return { allCash, withStock, difference: withStock.totalFutureValue - allCash.futureValue, breakEvenPrice, breakEvenChange, recommendation: withStock.totalFutureValue >= allCash.futureValue ? 'stock' : 'cash' };
    }

    function formatCurrency(value) { return new Intl.NumberFormat('ko-KR', { style: 'currency', currency: 'KRW', maximumFractionDigits: 0 }).format(value); }
    function formatCurrencyShort(value) {
        if (value >= 100000000) return (value / 100000000).toFixed(1) + 'ì–µ';
        if (value >= 10000) return Math.round(value / 10000).toLocaleString() + 'ë§Œ';
        return value.toLocaleString() + 'ì›';
    }

    // ==================== Chart Manager ====================
    const ChartManager = {
        ratioChart: null,
        priceScenarioChart: null,
        colors: {
            cash: 'rgba(251, 191, 36, 0.8)',
            stock: 'rgba(34, 197, 94, 0.8)',
            remainder: 'rgba(156, 163, 175, 0.8)',
            ratioColors: ['rgba(239, 68, 68, 0.8)', 'rgba(249, 115, 22, 0.8)', 'rgba(234, 179, 8, 0.8)', 'rgba(132, 204, 22, 0.8)', 'rgba(34, 197, 94, 0.8)', 'rgba(6, 182, 212, 0.8)'],
            ratioBorders: ['rgb(239, 68, 68)', 'rgb(249, 115, 22)', 'rgb(234, 179, 8)', 'rgb(132, 204, 22)', 'rgb(34, 197, 94)', 'rgb(6, 182, 212)']
        },

        getCommonOptions() {
            const isDark = document.documentElement.classList.contains('dark');
            return {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { labels: { color: isDark ? '#e5e7eb' : '#374151' } } },
                scales: {
                    x: { ticks: { color: isDark ? '#9ca3af' : '#6b7280' }, grid: { color: isDark ? 'rgba(75,85,99,0.3)' : 'rgba(209,213,219,0.5)' } },
                    y: { ticks: { color: isDark ? '#9ca3af' : '#6b7280', callback: v => (v/10000).toLocaleString()+'ë§Œ' }, grid: { color: isDark ? 'rgba(75,85,99,0.3)' : 'rgba(209,213,219,0.5)' } }
                }
            };
        },

        updateRatioChart(scenarios) {
            const ctx = document.getElementById('ratio-chart');
            if (!ctx) return;
            if (this.ratioChart) this.ratioChart.destroy();
            this.ratioChart = new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: scenarios.map(s => s.stockRatio + '%'),
                    datasets: [
                        { label: 'í˜„ê¸ˆ (ì„¸ì „)', data: scenarios.map(s => s.cashAmountGross), backgroundColor: this.colors.cash, borderRadius: 4 },
                        { label: 'ì£¼ì‹ ê°€ì¹˜', data: scenarios.map(s => s.futureStockValue), backgroundColor: this.colors.stock, borderRadius: 4 },
                        { label: 'ì°¨ì•¡', data: scenarios.map(s => s.remainder), backgroundColor: this.colors.remainder, borderRadius: 4 },
                        { label: 'ì„¸ê¸ˆ', data: scenarios.map(s => -s.opiTaxAmount), backgroundColor: 'rgba(239, 68, 68, 0.7)', borderRadius: 4 }
                    ]
                },
                options: { ...this.getCommonOptions(), scales: { ...this.getCommonOptions().scales, x: { ...this.getCommonOptions().scales.x, stacked: true }, y: { ...this.getCommonOptions().scales.y, stacked: true } } }
            });
        },

        updatePriceScenarioChart(priceScenarios) {
            const ctx = document.getElementById('price-scenario-chart');
            if (!ctx) return;
            if (this.priceScenarioChart) this.priceScenarioChart.destroy();
            this.priceScenarioChart = new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: priceScenarios.map(ps => (ps.priceChange > 0 ? '+' : '') + ps.priceChange + '%'),
                    datasets: CONFIG.STOCK_RATIO_OPTIONS.map((ratio, i) => ({
                        label: ratio + '%', data: priceScenarios.map(ps => ps.scenarios[i].totalReceived),
                        borderColor: this.colors.ratioBorders[i], backgroundColor: this.colors.ratioColors[i], fill: false, tension: 0.3
                    }))
                },
                options: { ...this.getCommonOptions(), interaction: { intersect: false, mode: 'index' } }
            });
        }
    };

    // ==================== UI ====================
    const UI = {
        elements: {},
        currentResult: null,

        init() {
            this.cacheElements();
            this.bindEvents();
            this.initDarkMode();
        },

        cacheElements() {
            this.elements = {
                form: document.getElementById('simulator-form'),
                annualSalary: document.getElementById('annual-salary'),
                opiRate: document.getElementById('opi-rate'),
                opiRateValue: document.getElementById('opi-rate-value'),
                basePrice: document.getElementById('base-price'),
                futurePrice: document.getElementById('future-price'),
                results: document.getElementById('results'),
                optimalRatio: document.getElementById('optimal-ratio'),
                opiAmount: document.getElementById('opi-amount'),
                maxTotal: document.getElementById('max-total'),
                comparisonTable: document.getElementById('comparison-table')?.querySelector('tbody'),
                priceScenarioTable: document.getElementById('price-scenario-table')?.querySelector('tbody'),
                taxComparison: document.getElementById('tax-comparison'),
                breakevenAnalysis: document.getElementById('breakeven-analysis'),
                darkModeToggle: document.getElementById('dark-mode-toggle'),
                loading: document.getElementById('loading')
            };
        },

        bindEvents() {
            this.elements.opiRate?.addEventListener('input', e => { this.elements.opiRateValue.textContent = e.target.value + '%'; });
            this.elements.form?.addEventListener('submit', e => { e.preventDefault(); this.runSimulation(); });
            [this.elements.annualSalary, this.elements.basePrice, this.elements.futurePrice].filter(Boolean).forEach(input => {
                input.addEventListener('blur', e => { if (e.target.value) { const n = parseInt(e.target.value.replace(/,/g, '')); if (!isNaN(n)) e.target.value = n.toLocaleString(); } });
                input.addEventListener('focus', e => { e.target.value = e.target.value.replace(/,/g, ''); });
            });
            this.elements.darkModeToggle?.addEventListener('click', () => this.toggleDarkMode());
        },

        getInputValues() {
            return {
                annualSalary: parseInt(this.elements.annualSalary?.value.replace(/,/g, '') || '0'),
                opiRate: parseInt(this.elements.opiRate?.value || '0'),
                baseStockPrice: parseInt(this.elements.basePrice?.value.replace(/,/g, '') || '0'),
                futureStockPrice: parseInt(this.elements.futurePrice?.value.replace(/,/g, '') || '0')
            };
        },

        validateInputs(p) {
            if (isNaN(p.annualSalary) || p.annualSalary <= 0) { alert('ê³„ì•½ì—°ë´‰ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return false; }
            if (isNaN(p.baseStockPrice) || p.baseStockPrice <= 0) { alert('ê¸°ì¤€ì£¼ê°€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return false; }
            if (isNaN(p.futureStockPrice) || p.futureStockPrice <= 0) { alert('ë¯¸ë˜ ì˜ˆìƒ ì£¼ê°€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return false; }
            return true;
        },

        runSimulation() {
            const params = this.getInputValues();
            if (!this.validateInputs(params)) return;
            this.elements.loading.classList.remove('hidden');

            setTimeout(() => {
                const result = calculateAllScenarios(params);
                const priceScenarios = analyzePriceScenarios(params);
                const taxComparison = compareTaxImpact({ ...params, stockRatio: result.optimalRatio });
                this.currentResult = { params, result, priceScenarios, taxComparison };

                this.elements.optimalRatio.textContent = result.optimalRatio + '%';
                this.elements.opiAmount.textContent = formatCurrencyShort(result.optimalScenario.opiAmount);
                this.elements.maxTotal.textContent = formatCurrencyShort(result.optimalScenario.totalReceived);

                this.updateComparisonTable(result.scenarios, result.optimalRatio);
                this.updatePriceScenarioTable(priceScenarios);
                this.updateTaxComparison(taxComparison, result.optimalRatio);
                this.updateBreakevenAnalysis(taxComparison, params);

                ChartManager.updateRatioChart(result.scenarios);
                ChartManager.updatePriceScenarioChart(priceScenarios);

                this.elements.results.classList.remove('hidden');
                this.elements.results.scrollIntoView({ behavior: 'smooth' });
                this.elements.loading.classList.add('hidden');
            }, 100);
        },

        updateComparisonTable(scenarios, optimalRatio) {
            const tbody = this.elements.comparisonTable;
            tbody.innerHTML = '';
            scenarios.forEach(s => {
                const isOptimal = s.stockRatio === optimalRatio;
                const row = document.createElement('tr');
                row.className = isOptimal ? 'bg-indigo-50 dark:bg-indigo-900/30 font-semibold' : 'hover:bg-gray-50 dark:hover:bg-gray-700/50';
                row.innerHTML = `
                    <td class="px-4 py-3">${isOptimal ? '<span class="text-indigo-600 dark:text-indigo-400 mr-1">â˜…</span>' : ''}${s.stockRatio}%</td>
                    <td class="px-4 py-3 text-right">${s.stockCount.toLocaleString()}ì£¼</td>
                    <td class="px-4 py-3 text-right text-green-600 dark:text-green-400">+${formatCurrencyShort(s.additionalBenefit)}</td>
                    <td class="px-4 py-3 text-right">${formatCurrencyShort(s.futureStockValue)}</td>
                    <td class="px-4 py-3 text-right">${formatCurrencyShort(s.opiTaxableIncome)}</td>
                    <td class="px-4 py-3 text-right text-red-500">-${formatCurrencyShort(s.opiTaxAmount)}</td>
                    <td class="px-4 py-3 text-right font-bold ${isOptimal ? 'text-indigo-600 dark:text-indigo-400' : ''}">${formatCurrencyShort(s.totalReceived)}</td>`;
                tbody.appendChild(row);
            });
        },

        updatePriceScenarioTable(priceScenarios) {
            const tbody = this.elements.priceScenarioTable;
            tbody.innerHTML = '';
            priceScenarios.forEach(ps => {
                const row = document.createElement('tr');
                row.className = ps.priceChange === 0 ? 'bg-gray-50 dark:bg-gray-700/50' : 'hover:bg-gray-50 dark:hover:bg-gray-700/50';
                const changeClass = ps.priceChange > 0 ? 'text-green-600 dark:text-green-400' : ps.priceChange < 0 ? 'text-red-600 dark:text-red-400' : '';
                row.innerHTML = `
                    <td class="px-3 py-2 ${changeClass} font-medium">${ps.priceChange > 0 ? '+' : ''}${ps.priceChange}%</td>
                    <td class="px-3 py-2 text-right">${formatCurrencyShort(ps.futurePrice)}</td>
                    ${ps.scenarios.map(s => `<td class="px-3 py-2 text-right text-sm">${formatCurrencyShort(s.totalReceived)}</td>`).join('')}
                    <td class="px-3 py-2 text-right font-bold text-indigo-600 dark:text-indigo-400">${ps.optimalRatio}%</td>`;
                tbody.appendChild(row);
            });
        },

        updateTaxComparison(c, optimalRatio) {
            this.elements.taxComparison.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-amber-50 dark:bg-amber-900/20 rounded-xl p-5 border border-amber-200 dark:border-amber-800">
                        <h4 class="font-bold text-lg mb-4 text-amber-700 dark:text-amber-400">100% í˜„ê¸ˆ ìˆ˜ë ¹</h4>
                        <div class="space-y-2">
                            <div class="flex justify-between"><span class="text-gray-600 dark:text-gray-400">OPI ì„¸ì „ ê¸ˆì•¡</span><span class="font-semibold">${formatCurrency(c.allCash.grossAmount)}</span></div>
                            <div class="flex justify-between"><span class="text-gray-600 dark:text-gray-400">ê³¼ì„¸ ì†Œë“</span><span>${formatCurrency(c.allCash.taxableIncome)}</span></div>
                            <div class="flex justify-between"><span class="text-gray-600 dark:text-gray-400">ì„¸ê¸ˆ (4ëŒ€ë³´í—˜+ì†Œë“ì„¸)</span><span class="text-red-500">-${formatCurrency(c.allCash.tax)}</span></div>
                            <div class="border-t border-amber-300 dark:border-amber-700 pt-2 flex justify-between"><span class="font-bold">ì„¸í›„ ìˆ˜ë ¹ì•¡</span><span class="font-bold text-xl text-amber-700 dark:text-amber-400">${formatCurrency(c.allCash.netAmount)}</span></div>
                        </div>
                    </div>
                    <div class="bg-green-50 dark:bg-green-900/20 rounded-xl p-5 border border-green-200 dark:border-green-800">
                        <h4 class="font-bold text-lg mb-4 text-green-700 dark:text-green-400">ì£¼ì‹ ${optimalRatio}% ì„ íƒ</h4>
                        <div class="space-y-2">
                            <div class="flex justify-between"><span class="text-gray-600 dark:text-gray-400">ì§€ê¸‰ ì£¼ì‹ìˆ˜</span><span class="font-semibold">${c.withStock.stockCount.toLocaleString()}ì£¼</span></div>
                            <div class="flex justify-between text-green-600 dark:text-green-400"><span>15% ì¶”ê°€í˜œíƒ</span><span>+${formatCurrencyShort(c.withStock.additionalBenefit)}</span></div>
                            <div class="flex justify-between"><span class="text-gray-600 dark:text-gray-400">ì£¼ì‹ ê°€ì¹˜ (1ë…„ í›„)</span><span>${formatCurrency(c.withStock.futureStockValue)}</span></div>
                            <div class="flex justify-between"><span class="text-gray-600 dark:text-gray-400">ê³¼ì„¸ ì†Œë“</span><span>${formatCurrency(c.withStock.taxableIncome)}</span></div>
                            <div class="flex justify-between"><span class="text-gray-600 dark:text-gray-400">ì„¸ê¸ˆ (4ëŒ€ë³´í—˜+ì†Œë“ì„¸)</span><span class="text-red-500">-${formatCurrency(c.withStock.tax)}</span></div>
                            <div class="border-t border-green-300 dark:border-green-700 pt-2 flex justify-between"><span class="font-bold">ì„¸í›„ ì‹¤ìˆ˜ë ¹ì•¡</span><span class="font-bold text-xl text-green-700 dark:text-green-400">${formatCurrency(c.withStock.totalFutureValue)}</span></div>
                        </div>
                    </div>
                </div>
                <div class="mt-6 p-4 rounded-xl ${c.difference >= 0 ? 'bg-green-100 dark:bg-green-900/30 border border-green-300 dark:border-green-700' : 'bg-red-100 dark:bg-red-900/30 border border-red-300 dark:border-red-700'}">
                    <div class="text-center">
                        <span class="text-gray-600 dark:text-gray-400">ì£¼ì‹ ì„ íƒ ì‹œ ì˜ˆìƒ ì°¨ì´</span>
                        <div class="text-2xl font-bold ${c.difference >= 0 ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}">${c.difference >= 0 ? '+' : ''}${formatCurrency(c.difference)}</div>
                    </div>
                </div>`;
        },

        updateBreakevenAnalysis(c, params) {
            this.elements.breakevenAnalysis.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h4 class="font-semibold text-gray-700 dark:text-gray-300 mb-3">ì†ìµë¶„ê¸° ë¶„ì„</h4>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between"><span class="text-gray-600 dark:text-gray-400">ê¸°ì¤€ì£¼ê°€</span><span class="font-medium">${formatCurrency(params.baseStockPrice)}</span></div>
                            <div class="flex justify-between"><span class="text-gray-600 dark:text-gray-400">ì†ìµë¶„ê¸° ì£¼ê°€</span><span class="font-medium text-indigo-600 dark:text-indigo-400">${formatCurrency(c.breakEvenPrice)}</span></div>
                            <div class="flex justify-between"><span class="text-gray-600 dark:text-gray-400">í—ˆìš© í•˜ë½í­</span><span class="font-medium text-green-600 dark:text-green-400">${c.breakEvenChange.toFixed(1)}%</span></div>
                        </div>
                        <p class="mt-3 text-sm text-gray-500 dark:text-gray-400">15% ì¶”ê°€í˜œíƒìœ¼ë¡œ ì£¼ê°€ê°€ ì•½ <strong>${Math.abs(c.breakEvenChange).toFixed(1)}%</strong> í•˜ë½í•´ë„ í˜„ê¸ˆ ìˆ˜ë ¹ê³¼ ë™ì¼</p>
                    </div>
                    <div class="bg-gradient-to-br from-indigo-50 to-purple-50 dark:from-indigo-900/30 dark:to-purple-900/30 rounded-xl p-5">
                        <h4 class="font-semibold text-indigo-700 dark:text-indigo-400 mb-3">ì¶”ì²œ ì „ëµ</h4>
                        ${c.recommendation === 'stock' ? `<div class="flex items-start gap-3"><span class="text-2xl">ğŸ“ˆ</span><div><p class="font-medium">ì£¼ì‹ ì„ íƒ ì¶”ì²œ</p><p class="text-sm text-gray-600 dark:text-gray-400 mt-1">ì˜ˆìƒ ì£¼ê°€(${formatCurrencyShort(params.futureStockPrice)})ê°€ ì†ìµë¶„ê¸°ì (${formatCurrencyShort(c.breakEvenPrice)})ë³´ë‹¤ ë†’ìŠµë‹ˆë‹¤.</p></div></div>` : `<div class="flex items-start gap-3"><span class="text-2xl">ğŸ’µ</span><div><p class="font-medium">í˜„ê¸ˆ ìˆ˜ë ¹ ê³ ë ¤</p><p class="text-sm text-gray-600 dark:text-gray-400 mt-1">ì˜ˆìƒ ì£¼ê°€ê°€ ì†ìµë¶„ê¸°ì ë³´ë‹¤ ë‚®ìŠµë‹ˆë‹¤.</p></div></div>`}
                    </div>
                </div>`;
        },

        initDarkMode() {
            const saved = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (saved === 'dark' || (!saved && prefersDark)) document.documentElement.classList.add('dark');
        },

        toggleDarkMode() {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        }
    };

    // Initialize
    document.addEventListener('DOMContentLoaded', () => UI.init());
    </script>
</body>
</html>
